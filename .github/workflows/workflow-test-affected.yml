name: 'Test Affected 🧪'

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Project name'
        required: true
        type: string
    outputs:
      is_affected:
        description: 'Project is included in affected projects'
        value: ${{ jobs.test_affected.outputs.has_affected }}

jobs:
  test_affected:
    runs-on: ubuntu-latest
    name: 'Test Affected 🧪'
    steps:
      - name: 'Checkout 📥'
        uses: actions/checkout@v4
        with:
          # Number of commits to fetch. 0 indicates all history for all branches and tags.
          fetch-depth: 0
          submodules: true

      - name: 'Install dependencies 📦'
        uses: ./.github/actions/install-deps

      - name: 'Get base 📦'
        id: get_base
        run: |
          base="origin/main"
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            base="HEAD~1"
          fi

          echo "using base: $base"
          echo "base=$base" >> $GITHUB_OUTPUT

      - name: 'Check affected 🔍'
        id: check_affected
        run: |
          base="${{ steps.get_base.outputs.base }}"
          echo "running: npx nx show projects --affected --base=$base --plain"
          affected=$(npx nx show projects --affected --base=$base --plain)
          has_affected="No"
          if [[ "${affected}" == *"${{ inputs.project_name }}"* ]]; then
            has_affected="Yes"
          fi

          echo "affected projects: $affected"

          echo "has_affected=$has_affected" >> $GITHUB_OUTPUT
        env:
          NX_REJECT_UNKNOWN_LOCAL_CACHE: 0

      - name: 'Test affected 🧪'
        if: |
          steps.check_affected.outputs.has_affected == 'Yes' &&
          github.event.action != 'closed'
        run: |
          echo "running: npx nx affected -t test -c ci"
          npx nx affected -t test -c ci
        env:
          NX_REJECT_UNKNOWN_LOCAL_CACHE: 0

    outputs:
      has_affected: ${{ steps.check_affected.outputs.has_affected }}
